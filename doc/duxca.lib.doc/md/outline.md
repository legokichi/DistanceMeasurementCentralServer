# 複数の携帯端末による教室空間の空間音響環境構築手法の検討

# [概要](introduction.md)
個人が所有するスマートデバイスを用いて空間音響を構築し相互の位置に応じた音による情報提供を行うシステムを開発した。

## 背景
* 身近にあふれるスマートデバイス
* ディスプレイやスピーカや多様なセンサを搭載
* たくさんのデバイスを同期的に制御したいという欲求

## 事例
* ディスプレイを同期 => マルチディスプレイ
* マイクロホンを同期 => アドホックマイクロホンアレイ
* スピーカを活用 => ???

### マルチディスプレイ
* マルチ映像, マルチ音響を用いたメディアアート表現

### アドホックマイクロホンアレイ
* マルチ映像, マルチ音響を用いたメディアアート表現

## スピーカ
スピーカを利用したものは未開拓

## 必要となる技術
* 端末間の同期制御
* 相対位置推定
* 空間音響の再生


# [位置推定と同期手法](localization.md)

## 位置推定と同期手法
* どのようにして端末間の相対位置を求めるか
* どのようにして端末間の時刻を同期するか

=> 端末のスピーカとマイクロホンを利用

## 質問信号と応答信号の時間差による測距と同期
![Two-way communication between nodes](clock_synchronization.png)
* 端末Bは端末Aがパルスを発した時刻$t_0$と、相対距離を知りたい
* 音速$c$を仮定すると信号の往復時間から答えが求まる
$$
t_0' = t_1 - \frac{(t_3 - t_0) - (t_2 - t_1)}{2}
$$

$$
d_{AB} = \frac{(t_3 - t_0) - (t_2 - t_1)}{2c}
$$

## 非計量多次元尺度法による相対位置推定
* 各端末の相対距離から全体の分布を推定
* 計測距離と空間の推定位置との二乗誤差を最小化する最適化問題
* 最急降下法で解く
$$
\begin{align}
\\
& S_{tress} \overset{\mathrm{def}}{=}
\sqrt{
  \frac
  {\sum_{i=1}^N \sum_{j \in M(i)} (\|\hat{x}_i - \hat{x}_j\| - d_{ij})^2}
  {\sum_{i=1}^N \sum_{j \in M(i)} d_{ij}^2}
}\\
\\
\end{align}
$$

## 相対距離から現在位置を推定
![](mds.png)

## パルス検出手法
![](block_diagram.png)
* 相関検出器を利用
* ノイズの乗った受信信号と元信号の相互相関を取るフィルタ

## 高精度パルスの検出の必要性
* 44100Hzサンプリング周波数のとき音速を340m/sとすると$\pm$1msの誤差で$\pm$34cm
* 人間の聴覚特性により各スピーカからの音に1ms以上の遅延が出ると違和感生じる
* 高精度なパルスの到来時刻の検出が必要

## [パルス圧縮と符号化](signal_processing.md)
* $\delta$関数を模した単一パルスが理想的だが実現困難
* 時間方向や周波数方向へエネルギーを分散するパルス圧縮技術が必要

### チャープパルスとTSPパルスとあいまい度関数

### Barker系列による時間方向へのパルス圧縮
* 長さ$N$の有限長系列で、同期点以外での自己相関関数の絶対値の最大が$1/N$となるもの
* $\delta$関数に近い理想的な相関特性を持つ
* $N=13$の場合、+++++--++-+-+
* 時間方向にエネルギーが増える

![](barker_autocorr.png)

### チャープパルスによる周波数方向へのパルス圧縮
* 徐々に周波数が上がる(下がる)ような変調がされたsine信号
* 周波数方向にエネルギーが増える

![](chirp.png)

### BPSKで両者を組み合わせた手法
* 二値位相切り換え系(BPSK)を用いてチャープパルスをbarker符号化
* barker系列の+に通常チャープ、-に逆位相チャープを使う
* 周波数方向と時間方向に圧縮された強力なパルスが作れる
![](barker_chirp.png)
![](barker_bpsk_0.png)
![](barker_bpsk_1.png)

### 単純チャープとBPSKでbarker符号化したチャープの比較
![](chirp_spectogram.png)
![](barker_coded_chirp.png)
* 単純チャープに比べ時間方向にエネルギーが増えている

## 各端末のパルス発生のスケジューリング手法
* いつどの端末がパルスを発するのか？
* パルス同士が衝突しないような帯域の排他制御が必要
* トークンリングを用いたTDMAで解決

## トークンリングによる分散排他制御
* トークンを持っているノードだけが資源(帯域)にアクセスできる
* リングネットワークの構築にはP2P-DHT Chordアルゴリズムを流用
![](chord_ring_network.png)

## 3ノードの場合の同期測距の時系列
![](flowchart.png)
* 端末Aの時分割された観測波形
![](rawdata.png)
* 端末Aの各区間の相関検出結果
![](corrA.png)
![](corrB.png)
![](corrC.png)

## 計測結果
* MBAを1辺2mの正三角形に配置
* 10回計測したときの検出時刻差の統計

|端末間|平均(s)|最頻値(s)|中央値(s)|標準偏差|推定距離(m)|
|--|--|--|--|--|--|
|A-B|0.0061|0.0061|0.0061|0.00001|2.08|
|A-C|0.0066|0.0067|0.0067|0.00013|2.27|
|B-C|0.0057|0.0057|0.0057|0.00001|1.94|
* 高精度に測距できた

## 同期測距まとめ
* 時刻同期と測距は質問パルスと応答パルスの時刻差から求まる
* 高精度パルス検出のために複数のパルス圧縮手法を組み合わせた
* うまくいった


# [空間音響の構築](spatial_hearing.md)

## 空間音響の構築
* 測距同期したシステムでどのような音響効果を実現するのか
* 仮想音源を配置し定位させられる
* 「音のひろがり」や「音に包まれた感じ」を実現できる

## 音像定位の手法
* 人間は音圧勾配(両耳間音圧差)で音像定位する
* 仮想音源を囲む最寄りの3ノードを鳴らすことで音像定位する

![](virtualsound.png)

## 音の広がり知覚
* 複数のスピーカを使うことの副作用
* 外にいる人は__みかけの音源の幅__(ASW: auditory source width)が生じる
  * 「先行音（直接音）の到来方向に先行音と時間的にも空間的にも融合して知覚される音の大きさ」
* 中にいる人は__音に包まれた感じ__(LEV: listener envelopment)が生じる
  * 「みかけの音源以外の音像によって聞き手のまわりが満たされている感じ」

## 音の広がり知覚
![](ASW_LEV.png)

## 空間音響まとめ
* 音圧差で音の定位を実現する
* 仮想音源付近の人は「音に包まれた感じ」を感じる
* 仮想音源から離れた人は「みかけの音源の幅」が大きくなる

## 既知の問題
* 障害物によってダイレクトパスが存在しない場合距離を正しく測定できない
  * 5m以上離れて使う必要はないのでそれ以上の距離を検出した場合は外れ値として無視してしまおう
* スピーカとマイクロホンのレベルが端末ごとに異なる
  * なんらかの相互校正法を組み込みたい

## 今後の展開
* 仮想音源の動的な移動
* チャープ+barker符号から加算M系列符号化へ
* システムにGUIつける
* 音像定位の実験
