
# 位置推定と同期手法
信号伝播による測距と測位は様々な分野で利用されている。
例えば、電波を用いたレーダー、海中における音波を利用したソーナーがある。
(測位には測距が重要、測距には時間同期が重要であることのウンチクをつらつら。GPSとか。)
この章では測距測位の基本原理について説明する。


## 測位方法

信号伝播による測位は、基本的には三角測量の原理を利用している。
すなわち、三角形のある一辺の長さと二つの頂点の角度、二つの辺の長さと一つの頂点の角度、三つの辺の長さ。
これらのいずれかが分かれば、相対位置が算出できる。

信号源の角度、到来方向(DOA; direction of arrival, AOA: angle of arrival)を求めるには、指向性を持つ受信機を回転させて角度を求めたり、大量の受信機を並べて受信機ごとの位相差から角度を求めるフェイズドアレイシステムがある。
しかしながら、この手法は人がその場で回らなければならないため、本研究のような多数の端末を使う上では欠点になる。
携帯端末の音と角度を用いて測位を行うシステムに、(ここに関連研究、持ったままその場で回転するやつ)がある。
また、複数の携帯端末を利用してフェイズドアレイシステムを構築する研究は(ワイヤレスアドホックマイクロホンアレイとかなんとか）と呼ばれ、2010年頃から盛んに研究されている[関連研究ほげほげ]。
この手法も!!!!!!!!!!????????
よって通常の携帯端末のみを使って相対位置を求めるには、端末間の相対距離がわかれば良い。


## 位置推定技術の分類

信号をつかって距離を求めるには、
信号の距離減衰を元に信号源の相対位置を推定する信号強度法(RSS:Received Signal Strength)、
信号の到来時刻を元に推定する(TOA:Time of Arrival)、
到着時間差法(TDOA:time difference of arrival)、
到着周波数偏差法(FDOA; frequency diffrence of arrival)
がある。

### RSS:Received Signal Strength
* 例: BLE
* この辺に波動方程式

### TOA:Time of Arrival
* パルスレーダー AOA+TOA
* アクティブソナー AOA+TOA

### TDOA:time difference of arrival
* フェイズドアレイレーダー
* GPS

### FDOA
* トーン測距

## 到来時間による測距と同期
TOAを用いたトランスポンダによる測距を詳しく説明する。

各端末のスピーカの位置とマイクロホンの位置を近似的に等しいと仮定する。
空間上に分布する$N \in \mathbb{N}$個の端末の位置を、
$n$次元ユークリッド空間の元の族$\{x_i \mid i \in \{1,N\} \}$として表す。
また、端末$x_i x_j$間の距離をユークリッド距離を

$$
d_{ij} \overset{\mathrm{def}}{=} \|x_i - x_j\| = \sqrt{(x_i - x_j)\cdot(x_i - x_j)}
$$

として定義する。
端末間を信号が伝播する時間を到来時間$\tau_{kl}$といい、これは信号伝播速度を$c$として、

$$
\tau_{kl} = \frac{d_{ij}}{c}
$$

のように表せる。

### a

![Two-way communication between nodes](clock_synchronization.png)

$$
t_0' = t_1 - \frac{(t_3 - t_0) - (t_2 - t_1)}{2}
$$

$$
c = \sqrt{\frac{\kappa}{\rho_0}}
$$

$$
d_{AB} = \frac{(t_3 - t_0) - (t_2 - t_1)}{2c}
$$

* 今回はパルスレーダー+二次レーダー+TDOAを用いる
* パルスレーダー+トランスポンダ+TDOA+通信回線で測距が可能
  * ワイヤレスセンサネットワークなので通信回線を介した情報共有が可能
  * トーン測距が最も正確に測距できるがうるさいし調整に時間がかかる

(TPSN: Timing-sync Protocol for Sensor Networks)[[Ganeriwal2003] Ganeriwal, S., Kumar, R., Srivastava, M. (2003). "Timing-Sync Protocol for Sensor Networks.", The First ACM Conference on Embedded Networked Sensor Systems (SenSys), p. 138-149]

## アンカーノードフリーの相対位置の推定方法(BeepToBeep)
* TDOA(BeepToBeep)で相対距離がわかる
* 相対距離がわかれば時刻同期が可能
* 相対距離がわかれば多次元尺度法で相対位置も求まる(全ての音源,マイクロホン間の距離が得られるのであれば,多 次元尺度法 (MDS) が適用できる).
* 相対距離から全体の端末の相対分布を推定

## 非計量多次元尺度法による相対位置推定

多次元尺度法(MDS; Multi Dimensional Scaling)は、高次元のデータを低次元に縮約する手法である。
MDS法は、何らかの測度に基づくデータ間の距離を元に高次元データを低次元のユーグリッド空間に再配置する。
特に二次元に次元縮約することで、高次元データを散布図として表現できるようになる。
距離の公理を満たすデータに対しては代数的に解くことができる計量多次元尺度法(metric MDS)がある。
しかし、誤差あるいは距離が計測できない場合などの距離の公理が成り立たない場合はこれは使えない。
このようなデータには数値計算的に多次元尺度法を適用できる非計量多次元尺度法(non-metric MDS)が提案されている。
[GUTTMAN, L. A basis for scaling qualitative data. American Sociological Review, 1944, 9, 139-150. ]
[KRUSKAL, J. B. Non-metric multidimensional scaling: A numerical method. Psychometrika,
1964, 29, 115129. (b)]
非計量MDS法によって端末間の相対位置を求めるには、端末間の計測距離を$d_{ij}$、空間上の推定位置を$\hat{x}_i$とすると、
それらの二乗誤差をストレス関数と名付けられた目的関数として定義し、ストレス関数を最小化するような$\hat{x}_i$を勾配法(最急降下法)によって解く。[島村和希 センサ相対位置推定のための最適化手法 2012]

$$
\begin{align}
\\
& S_{tress} \overset{\mathrm{def}}{=}
\sqrt{
  \frac
  {\sum_{i=1}^N \sum_{j \in M(i)} (\|\hat{x}_i - \hat{x}_j\| - d_{ij})^2}
  {\sum_{i=1}^N \sum_{j \in M(i)} d_{ij}^2}
}\\
\\
\end{align}
$$

ここで$M(i)$は端末$i$が相対距離を計測できた端末の集合を表す。
端末$i$の$n$回目の位置推定値をを$\hat{x}_i (n)$として表すと、最急降下法による更新式は以下のようになる。

$$
\begin{align}
\hat{x}_i (n + 1) & = \hat{x}_i (n) +
\alpha \frac{\partial S_{tress}}{\partial \hat{x}_i}|_{\hat{x}_i = \hat{x}_i (n)}\\
\\
\frac{\partial S_{tress}}{\partial \hat{x}_i (n)} & = a\\
& = b\\
& = c
\end{align}
$$

ここで$\alpha$は最急降下法におけるステップ幅である。

このストレス関数の値の適合度は以下の表で判断する。[KRUSKAL, J. B. Multidimensional scaling by optimizing goodness of fit to a non-metric hypothesis.
Psychometrika, 1964, 29, l-27. (a) ]

|ストレス関数の値|適合の程度|
|-|-|-|
|0.200|良くない適合|
|0.100|悪くない適合|
|0.050|良い適合|
|0.025|非常に良い適合|
|0.000|完全に適合|

一般には音響信号の観測からは相対的な位置関係のみが推定可能であり,絶対的な位置や向きを決めることはできない.
すなわち,音源定位やマイクロホン定位においては,位置原点の選び方の自由度p,回転の自由度 p(p − 1)/2(注 3),あわせて p(p + 1)/2 の自由度は決められない.
同様に時間の絶対的な原点は決められないので,チャネル同期や音源同期においては,1 自由度は決 めることができないことに注意する必要がある


# 測距に必要な信号処理

## 変調方式

* 位相シフト変調(PSK; Phase shift keying)

![ここにBPSKのQI図,信号空間ダイヤグラム](chirp_qi.png)
![ここにBPSK変調の時間軸図](chirp_qi.png)

### デジタル変調波の復調

* デジタル変調では、ある周期をもって変調がなされ、その１周期に対応する変調波の情報の単位はシンボルで表される


* 送信機から送られたデジタル変調は、受信機で復調されて元の情報が復元される。
* 受信機では雑音などの不要成分が加わって、送ったシンボルと異なったシンボルに謝ってしまうことがある。（シンボル誤り)
* シンボル誤り率を最小にした受信器を最適受信機という
* 最適受信のためには符号判定の段階で信号対雑音比が最大になるようにする
* そのために整合フィルタや相関器がある
* 相関器では到来する信号と共役の波形の信号を受信機で用意しておき、これと入力波を掛け合わせたあと、シンボル期間にわたり積分する

* 復調の方式には同期検波と非同期検波がある

#### 同期検波
* 同期検波回路では受信変調波と周波数位相の一致した基準搬送波を再生し
* これを受信変調波と掛け合わせて復調する
* この同期検波回路は相関器を用いた最適受信機（相関検波回路）と等価である

![ここに同期検波回路のブロック線図](block_diagram.png)

* 相関検出器(coherent detection)
* 最適受信機
  * 整合フィルタ
  * 周波数軸上でのたたみ込み積分（相互相関）

![ここに相関検波回路のブロック線図](block_diagram.png)

* 相関検出器もここで説明

## パルス圧縮

### SN比と距離分解能とドップラシフト分解能とかのトレードオフについて
* この辺にパルスレーダーの距離分解能およびパルス圧縮の必要性について

### 各種パルス圧縮について
* 精度の定義
* パルスレーダーの距離分解能

### Chirp信号によるパルス圧縮のあいまいさ
* Chirp信号は線形FM信号、Swept-Sine信号、TimeStretchedPulseなどとも呼ばれる信号
* 持続時間が長くパルスのエネルギーを圧縮できる

![ここにchirp信号の一部が入る](chirp.png)
![ここにchirp信号のスペクトログラムが入る](chirp_spectogram.png)

#### swept-sine 信号の生成
* 単位パルスのフーリエ変換の位相を周波数の２乗に比例して増加
* 逆フーリエ変換して作成

$$
S(k) = \begin{cases}
  \exp(\frac{-j \pi k^2}{N}) & 0 \leq k \leq \frac{N}{2} \\
  S^*(N - k)                 & \frac{N}{2} \lt k \lt N
\end{cases}
$$

* $j$は虚数単位
* $*$は複素共益
* $N$は2の冪乗

* チャープ信号の帯域は可能な限り全体を使った。なぜならば、端末ごとにスピーカやマイクロホンの特性が異なるため、CDMAのように端末ごとに周波数を割り振るやり方では、ある端末には再生も検出もできない帯域を割り当ててしまうことがあるためである。
  * 単一チャープ信号のみでは精度が上がらない上、再生時間が長くなるため、個々のチャープ信号は短くし帯域を広げたのち、バーカー符号13を使いパルスを圧縮した。

### Barker系列によるパルス圧縮
* 長さ$N$の有限長系列で、同期点以外での自己相関関数の絶対値の最大が$1/N$となるもの
* ディラックの$\delta$関数に近い理想的な相関特性を持つ。

|N|系列|
|-|-|
|2|++, +-|
|3|++-|
|4|+++-, ++-+|
|5|+++-+|
|7|+++--+-|
|11|+++---+--+-|
|13|+++++--++-+-+|

* 系列間の相関関数(correlation function)が系列の乱雑さやシステム性能を表す指標
系列長$N$の二つの系列をa(t)とb(t)とすると、位相ずれ$\tau$において

$$
R_{ab}(\tau) = \sum_{i=0}^{N-1}a(i+\tau)b^*(i)
$$

と定義。ただし$b^*$は複素共役を示す。ここで、$a = b$の場合を自己相関関数と呼び、$a\neq b $の場合を相互相関関数と呼ぶ。

![ここにバーカー符号の自己相関関数の図が入る](barker_autocorr.png)

### M系列について

### Chirp信号をBarker系列でBPSKなどの例

![理想的な帯域](barker_coded_chirp.png)
![帯域が狭くなっている図](barker_coded_chirp_err.png)
![ここに使用した信号の波形が入る](barker_bpsk_0.png)
![ここに使用した信号の波形が入る](barker_bpsk_1.png)
![ここに使用した信号の波形が入る](barker_chirp.png)



# 多元接続

* TDMA バースト信号 帯域資源管理
  * 二次レーダーでは、互いの信号をTDOAを利用して測距するが、先述のとおりチャープ信号に全帯域を割り当てているため、各端末が同時におなじパルス発信すると混線してしまう。そこで、パルスの送信タイミングはTDMAを使った。
  * 分散排他制御 トークンリング
    * Chrod DHT P2P オーバーレイネットワーク
      * TDMAでは、各端末の送信タイミングを同期するためにバースト信号というパルスを利用するが、各端末はインターネットに接続していることを仮定しているため、バースト信号には音声を使わず、インターネット回線を利用し、Chrod DHTの技術を利用したP2Pリングネットワークを構築した。

## 時分割多元接続(TDMA; Time division multiple access)
* 全ての信号が同じ周波数帯域を占有
* 時間的に各信号を逐次分割して伝送
* フレーム分割によって帯域の衝突を避ける
  * フレームの始まりを送信側と合わせる、フレーム同期の確立が必要

![ここにTDMAの概念図が入る](TDMA.png)

* フレーム同期のためにはフレームの始まりを表現する本来バースト（マーカーとも）信号が必要だが
* 今回はアコースティックワイヤレスネットワークなのでバースト信号はインターネット回線を用いる。

## 帯域の分散排他制御とトークンリング
* TDMAによる多元接続ではフレーム同期が必要。
* 音空間の帯域という資源の分散排他制御問題。
  * トークンリングが使える
* トークンリングの利点と欠点
  * 自然に順序構造が入る
  * ノード数が増えるとトークンがリングを一周するのにかかる時間が長くなる

## 端末間通信
* TDMAにおける帯域の分散排他制御
* 分散排他制御 トークンリング
  * クロック同期問題
  * 順序関係、論理時計、時空ダイアグラム（シーケンス図
  * Chrod DHT P2P オーバーレイネットワーク
    * TDMAでは、各端末の送信タイミングを同期するためにバースト信号というパルスを利用するが、各端末はインターネットに接続していることを仮定しているため、バースト信号には音声を使わず、インターネット回線を利用し、Chrod DHTの技術を利用したP2Pリングネットワークを構築した。
* 音響通信
  * 誤り訂正符号
  * 全帯域パルスとBPSK
* QRコード

## Chordリングによるリングネットワーク構築
* DHTネットワーク構築アルゴリズムであるChordを使ってリングネットワークを構築
* P2Pによるオーバーレイネットワークによりhogeサーバーが必要ない

![token ring](chord_ring_network.png)



# マルチスピーカ
* 空間音響と頭部伝達関数
  * 距離知覚
    * 音圧レベル
    * 両耳位相差
    * 反射音
  * 広がり知覚
    * ASWとLEV
  * 聴覚マスキング
  * VAPとか



# 実装

* 実装の目的とか再三

## a

* チャープ信号の帯域は可能な限り全体を使った。なぜならば、端末ごとにスピーカやマイクロホンの特性が異なるため、CDMAのように端末ごとに周波数を割り振るやり方では、ある端末には再生も検出もできない帯域を割り当ててしまうことがあるためである。
  * 単一チャープ信号のみでは精度が上がらない上、再生時間が長くなるため、個々のチャープ信号は短くし帯域を広げたのち、バーカー符号13を使いパルスを圧縮した。
* 二次レーダーでは、互いの信号をTDOAを利用して測距するが、先述のとおりチャープ信号に全帯域を割り当てているため、各端末が同時におなじパルス発信すると混線してしまう。そこで、パルスの送信タイミングはTDMAを使った。
* TDMAでは、各端末の送信タイミングを同期するためにバースト信号というパルスを利用するが、各端末はインターネットに接続していることを仮定しているため、バースト信号には音声を使わず、インターネット回線を利用し、Chrod DHTの技術を利用したP2Pリングネットワークを構築した。
* 各端末の相対距離が測定できたのち、相対距離から全体の端末の相対分布を推定する。

* 信号の検波は同期検波方式で、相関検出器を利用した。
  * 音は距離の二乗に比例して減衰するため、パルス圧縮が必要である。パルス圧縮にはチャープ信号とバーカー符号を組み合わせて用いた。
    * 音の距離減衰とは。
    * パルス圧縮とは、微弱な信号を強化するための技術。
    * チャープ信号とは、
    * バーカー符号とは、合成開口レーダーや人工衛星などの通信に使われるパルス圧縮技術。
* チャープ信号の帯域は可能な限り全体を使った。なぜならば、端末ごとにスピーカやマイクロホンの特性が異なるため、CDMAのように端末ごとに周波数を割り振るやり方では、ある端末には再生も検出もできない帯域を割り当ててしまうことがあるためである。
  * 単一チャープ信号のみでは精度が上がらない上、再生時間が長くなるため、個々のチャープ信号は短くし帯域を広げたのち、バーカー符号13を使いパルスを圧縮した。

## リングネットワークによるTDMA

* ノード数3の場合のトークンリングによるフレーム分割のしくみを以下の図で示す

![message sequence diagram among three devices](./flowchart.png)

* ノードAが観測した波形とフレーム

![wave data of device A recording and those sections](./rawdata.png)

* ノードAが観測した波形のスペクトログラム

![first part of spectrogram of device A recording](./spectrogram.png)

* ノードAが観測したノードAのフレームの相関

![correlation of device A between pulse-signal and recording-data of section](./corrA.png)

* ノードAが観測したノードBのフレームの相関

![correlation of device B between pulse-signal and recording-data of section](./corrB.png)

* ノードAが観測したノードCのフレームの相関

![correlation of device C between pulse-signal and recording-data of section](./corrC.png)

* これらの各フレームのピーク間の時間はデバイスごとによって異なるので、ピーク間情報を全てのデバイスで共有する

* ここに推定される分布図



# 実験と評価
* 何を評価する必要があるか
* ダイレクトパスが存在しない場合、遮蔽物がある場合の影響


* 環境ごとのROC曲線、教室、深夜、屋外、端末の距離、端末の数、１
* ROC曲線を次に表示する。
  * ROC曲線とは、受動者動作特性曲線
* ダイレクトパスが存在しない場合、遮蔽物がある場合の影響

## パルス検出の評価
* 環境、マルチパスの影響、遮蔽物云々

### データとか
* 10回同期を行った後の統計値

|端末間|時刻差(s)|平均(s)|最頻値(s)|中央値(s)|標準偏差|
|--|--|--|--|--|--|
|A-B|0.006145124716553263|0.006132756132755864|0.006145124716442907|0.006145124716442907|0.000015590740384167865|
|A-C|0.006780045351473807|0.006691403834272489|0.006780045351473807|0.006757369614515674|0.00013317224811441986|
|B-C|0.005736961451247191|0.005734900020614608|0.0057369614512438605|0.005736961451247191|0.000012230382950422229|

* 最頻値はカーネル密度推定により求めた
  * 平滑化パラメータの求め方
    * h = 0.9 * stdev(arr) * Math.pow(arr.length, -1 / 5) + 0.0000000001;

## 時間同期の評価
* 同期後にパルスを再生し、マイクロホンからのラインアウト出力をICレコーダで録音し、相互相関にかける
* a

## 機器位置推定の評価
* 相対距離のズレ
* どこを原点とするか問題

## 音像定位
* 音の広がり知覚
  * みかけ音源の幅(ASW; auditory source width, apparent source width)
  * 音に包まれた感じ(LEV; listener envelopment)



# まとめ

## 実現できたこと

## 今後の課題
* CDMA、スペクトル拡散で多元接続＆人間に気づかれない程度の同期



# 付録：CSPによるシステムの形式的記述

![ここに構造図が入る](./content.png)
![ここに状態遷移図が入る](./states.png)

$$
\begin{align}
[[chan]]\\
PING & = ping \to PING \to BEGINREC\\
Join(id) & = succ!"amIYourPred?" \to WaitMSG\\
Stabilize & = succ! \to WaitMSG\\
WaitMSG(id) & = pred?m \to PassToken(id)\\
PassToken(id) & = succ!m \to WaitMSG(id) \\
\end{align}
$$
